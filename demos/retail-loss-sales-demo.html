<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <base href="/">
  <title>Store-Level Loss &amp; Sales ETL</title>
  <meta name="theme-color" content="#0b131b" />
  <link rel="stylesheet" href="dist/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500&family=Space+Grotesk:wght@500;600&display=swap">
  <style>
    :root {
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --page-pad: clamp(12px, 3vw, 28px);
      --surface: #0f1722;
      --surface-2: #151f2c;
      --surface-3: #1b2736;
      --surface-4: #233244;
      --surface-accent: rgba(255, 255, 255, 0.08);
      --text: #e6f0f5;
      --muted: #9bb0c3;
      --primary: #25c7a1;
      --primary-soft: rgba(37, 199, 161, 0.18);
      --accent: #f4b262;
      --accent-soft: rgba(244, 178, 98, 0.16);
      --danger: #ff7b7b;
      --success: #58d09b;
      --shadow-1: 0 10px 30px rgba(0, 0, 0, 0.35);
      --shadow-2: 0 18px 40px rgba(0, 0, 0, 0.45);
      --grid-line: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    html[data-embedded="true"],
    html[data-embedded="true"] body {
      height: auto !important;
      min-height: 0 !important;
    }

    html[data-embedded="true"] {
      --page-pad: clamp(8px, 2vw, 16px);
    }

    body {
      margin: 0;
      font-family: "IBM Plex Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(37, 199, 161, 0.18), transparent 60%),
        radial-gradient(700px 400px at 100% 0%, rgba(244, 178, 98, 0.2), transparent 65%),
        linear-gradient(140deg, #0b1118, #0c131c 60%, #0d1722 100%);
      display: grid;
      place-items: start center;
      padding: var(--page-pad);
    }

    #demo-shell {
      width: min(1220px, 100%);
      background: var(--surface);
      border: 1px solid var(--surface-accent);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto auto 1fr;
      min-height: calc(100vh - var(--page-pad) * 2);
      animation: rise 0.6s ease both;
    }

    @supports (height: 100dvh) {
      #demo-shell {
        min-height: calc(100dvh - var(--page-pad) * 2 - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
    }

    html[data-embedded="true"] #demo-shell {
      min-height: 0 !important;
    }

    header.card-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 18px 22px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), transparent);
      border-bottom: 1px solid var(--surface-accent);
    }

    .header-copy {
      display: grid;
      gap: 6px;
      min-width: 0;
    }

    .title {
      margin: 0;
      font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
      font-weight: 600;
      font-size: clamp(1.3rem, 2.4vw, 1.6rem);
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.92rem;
      max-width: 68ch;
    }

    .header-actions {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--surface-accent);
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      background: rgba(0, 0, 0, 0.2);
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(37, 199, 161, 0.5);
      background: rgba(37, 199, 161, 0.12);
      color: rgba(226, 255, 245, 0.9);
      padding: 6px 14px;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-ghost:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 20px rgba(37, 199, 161, 0.22);
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 22px 14px;
      border-bottom: 1px solid var(--surface-accent);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.68rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px solid var(--surface-accent);
      color: var(--muted);
      background: var(--surface-2);
    }

    .status-pill::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-pill[data-state="ok"] {
      color: var(--success);
      border-color: rgba(88, 208, 155, 0.6);
    }

    .status-pill[data-state="warming"] {
      color: var(--accent);
      border-color: rgba(244, 178, 98, 0.6);
    }

    .status-pill[data-state="err"] {
      color: var(--danger);
      border-color: rgba(255, 123, 123, 0.6);
    }

    .status-meta {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .status-note {
      margin-left: auto;
      font-size: 0.72rem;
      color: rgba(255, 255, 255, 0.45);
    }

    main.content {
      padding: 20px 22px 26px;
      display: grid;
      gap: 20px;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      grid-template-areas:
        "kpi kpi"
        "sales signals"
        "incidents signals";
    }

    .panel {
      background: var(--surface-2);
      border: 1px solid var(--surface-accent);
      border-radius: var(--radius-md);
      padding: 16px 18px;
      box-shadow: var(--shadow-1);
      display: grid;
      gap: 14px;
    }

    .panel-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .panel-title h2 {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      font-size: 1.05rem;
    }

    .panel-title h3 {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      font-size: 0.95rem;
    }

    .meta-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.68rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      border: 1px solid var(--surface-accent);
      background: rgba(0, 0, 0, 0.2);
    }

    .kpi-panel {
      grid-area: kpi;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .kpi-card {
      background: var(--surface-3);
      border: 1px solid var(--surface-accent);
      border-radius: var(--radius-sm);
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .kpi-card.is-accent {
      background: linear-gradient(140deg, rgba(37, 199, 161, 0.16), rgba(37, 199, 161, 0.04));
      border-color: rgba(37, 199, 161, 0.3);
    }

    .kpi-label {
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 1.4rem;
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
    }

    .kpi-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .kpi-breakout {
      display: grid;
      gap: 4px;
    }

    .kpi-breakout span {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .kpi-breakout strong {
      color: var(--accent);
      font-weight: 600;
    }

    .sales-panel {
      grid-area: sales;
    }

    .incident-panel {
      grid-area: incidents;
    }

    .signals-panel {
      grid-area: signals;
      display: grid;
      gap: 16px;
      align-content: start;
    }

    .chart-wrap {
      position: relative;
      width: 100%;
      height: 240px;
    }

    .chart-wrap.small {
      height: 200px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid var(--surface-accent);
      background: transparent;
      color: var(--muted);
      padding: 5px 12px;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn.is-active {
      border-color: rgba(37, 199, 161, 0.5);
      color: #e9fff7;
      background: rgba(37, 199, 161, 0.16);
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.78rem;
      color: var(--muted);
    }

    select {
      background: var(--surface-3);
      border: 1px solid var(--surface-accent);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.78rem;
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 10px;
    }

    .list-item {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--surface-accent);
      background: var(--surface-3);
      display: grid;
      gap: 8px;
    }

    .list-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }

    .list-title {
      font-size: 0.82rem;
      font-weight: 600;
    }

    .list-meta {
      font-size: 0.74rem;
      color: var(--muted);
    }

    .bar-track {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(37, 199, 161, 0.9), rgba(244, 178, 98, 0.8));
    }

    .table {
      display: grid;
      gap: 8px;
    }

    .table-row {
      display: grid;
      grid-template-columns: 1.2fr 0.7fr 0.8fr;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--surface-accent);
      background: var(--surface-3);
      font-size: 0.76rem;
    }

    .table-header {
      background: transparent;
      border: none;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.68rem;
    }

    .signal-block {
      display: grid;
      gap: 12px;
    }

    .empty-note {
      font-size: 0.74rem;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      main.content {
        grid-template-columns: 1fr;
        grid-template-areas:
          "kpi"
          "sales"
          "incidents"
          "signals";
      }
    }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <script>
    if (window.self !== window.top) {
      document.documentElement.setAttribute("data-embedded", "true");
    }
  </script>
</head>
<body>
  <div id="demo-shell" role="application" aria-label="Store loss and sales ETL demo">
    <header class="card-header">
      <div class="header-copy">
        <h1 class="title">Store-Level Loss &amp; Sales ETL</h1>
        <p class="subtitle">AWS-backed KPI cockpit for sales, incidents, shrink, and empty-package signals.</p>
      </div>
      <div class="header-actions">
        <span class="pill" id="date-range-pill">Loading dates</span>
        <button class="btn-ghost" id="reset-filters" type="button">Reset view</button>
      </div>
    </header>

    <div class="status-row" role="status" aria-live="polite">
      <span class="status-pill" id="status-pill" data-state="warming">Loading</span>
      <span class="status-meta" id="status-meta">Connecting to AWS...</span>
      <span class="status-note">All identifiers are anonymized.</span>
    </div>

    <main class="content">
      <section class="panel kpi-panel">
        <div class="panel-title">
          <h2>Executive KPIs</h2>
          <span class="meta-chip" id="kpi-meta">Loading metrics</span>
        </div>
        <div class="kpi-grid">
          <div class="kpi-card is-accent">
            <div class="kpi-label">Store Sales (YTD)</div>
            <div class="kpi-value" id="kpi-sales">--</div>
            <div class="kpi-sub" id="kpi-sales-sub">--</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Boycott YoY (May-Jul 23)</div>
            <div class="kpi-breakout" id="kpi-boycott">--</div>
            <div class="kpi-sub">Compared to 2022</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Incidents (Latest Year)</div>
            <div class="kpi-value" id="kpi-incidents">--</div>
            <div class="kpi-sub" id="kpi-incidents-sub">--</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Avg Shrink %</div>
            <div class="kpi-value" id="kpi-shrink">--</div>
            <div class="kpi-sub" id="kpi-shrink-sub">--</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Empty Package Value</div>
            <div class="kpi-value" id="kpi-empty">--</div>
            <div class="kpi-sub">Estimated retail value</div>
          </div>
        </div>
      </section>

      <section class="panel sales-panel">
        <div class="panel-title">
          <h2>Sales Pulse</h2>
          <div class="tabs" role="tablist" aria-label="Sales metric toggle">
            <button class="tab-btn is-active" type="button" data-sales-metric="sales">Total</button>
            <button class="tab-btn" type="button" data-sales-metric="online">Online</button>
            <button class="tab-btn" type="button" data-sales-metric="driveUp">Drive-up</button>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="sales-chart" aria-label="Monthly sales trend chart"></canvas>
        </div>
        <div class="panel-title">
          <h3>Top Departments</h3>
          <span class="meta-chip" id="dept-meta">Loading</span>
        </div>
        <ul class="list" id="dept-list"></ul>
      </section>

      <section class="panel incident-panel">
        <div class="panel-title">
          <h2>Incident Hotspots</h2>
          <div class="tabs" role="tablist" aria-label="Incident metric toggle">
            <button class="tab-btn is-active" type="button" data-incident-metric="incidents">Count</button>
            <button class="tab-btn" type="button" data-incident-metric="proven">Proven $</button>
          </div>
        </div>
        <div class="filter-row">
          <span>Region</span>
          <select id="incident-region" aria-label="Filter incidents by region">
            <option value="all">All regions</option>
          </select>
        </div>
        <div class="chart-wrap small">
          <canvas id="incident-chart" aria-label="Incident hotspots chart"></canvas>
        </div>
        <div class="panel-title">
          <h3>Top Stores</h3>
          <span class="meta-chip" id="incident-meta">Loading</span>
        </div>
        <div class="table" id="incident-table">
          <div class="table-row table-header">
            <div>Store</div>
            <div>Region</div>
            <div>Avg Value</div>
          </div>
        </div>
        <div class="panel-title">
          <h3>Outlier Signals</h3>
          <span class="meta-chip" id="outlier-meta">Z-score &gt; 2</span>
        </div>
        <ul class="list" id="outlier-list"></ul>
      </section>

      <section class="panel signals-panel">
        <div class="signal-block">
          <div class="panel-title">
            <h2>Shrink Trend</h2>
            <span class="meta-chip" id="shrink-meta">Loading</span>
          </div>
          <div class="chart-wrap small">
            <canvas id="shrink-chart" aria-label="Shrink trend chart"></canvas>
          </div>
        </div>
        <div class="signal-block">
          <div class="panel-title">
            <h2>Recovery Signals</h2>
            <div class="tabs" role="tablist" aria-label="Empty package toggle">
              <button class="tab-btn is-active" type="button" data-empty-metric="employees">Associates</button>
              <button class="tab-btn" type="button" data-empty-metric="areas">Areas</button>
              <button class="tab-btn" type="button" data-empty-metric="conditions">Conditions</button>
            </div>
          </div>
          <ul class="list" id="empty-list"></ul>
          <p class="empty-note" id="empty-note">Top signals from empty-package recoveries.</p>
        </div>
      </section>
    </main>
  </div>

  <script src="js/vendor/chartjs/chart.umd.min.js"></script>
  <script src="js/demos/aws-client.js"></script>
  <script type="module">
    const DEFAULT_API_URL = "https://oafstar74okqvfqaxayeici3ry0yikkx.lambda-url.us-east-2.on.aws/";
    const STORAGE_KEY = "demo.endpoint.retailLossSales";
    const { resolveEndpoint, joinUrl, getJson } = window.DemoAws;
    const API_URL = resolveEndpoint({ defaultUrl: DEFAULT_API_URL, storageKey: STORAGE_KEY });

    const state = {
      data: null,
      salesMetric: "sales",
      incidentMetric: "incidents",
      incidentRegion: "all",
      emptyMetric: "employees"
    };

    const DOM = {
      statusPill: document.getElementById("status-pill"),
      statusMeta: document.getElementById("status-meta"),
      dateRangePill: document.getElementById("date-range-pill"),
      kpiMeta: document.getElementById("kpi-meta"),
      kpiSales: document.getElementById("kpi-sales"),
      kpiSalesSub: document.getElementById("kpi-sales-sub"),
      kpiBoycott: document.getElementById("kpi-boycott"),
      kpiIncidents: document.getElementById("kpi-incidents"),
      kpiIncidentsSub: document.getElementById("kpi-incidents-sub"),
      kpiShrink: document.getElementById("kpi-shrink"),
      kpiShrinkSub: document.getElementById("kpi-shrink-sub"),
      kpiEmpty: document.getElementById("kpi-empty"),
      deptMeta: document.getElementById("dept-meta"),
      deptList: document.getElementById("dept-list"),
      incidentRegion: document.getElementById("incident-region"),
      incidentMeta: document.getElementById("incident-meta"),
      incidentTable: document.getElementById("incident-table"),
      outlierList: document.getElementById("outlier-list"),
      shrinkMeta: document.getElementById("shrink-meta"),
      emptyList: document.getElementById("empty-list"),
      emptyNote: document.getElementById("empty-note"),
      resetFilters: document.getElementById("reset-filters"),
      salesButtons: Array.from(document.querySelectorAll("[data-sales-metric]")),
      incidentButtons: Array.from(document.querySelectorAll("[data-incident-metric]")),
      emptyButtons: Array.from(document.querySelectorAll("[data-empty-metric]"))
    };

    const charts = {
      sales: null,
      incidents: null,
      shrink: null
    };

    const notifyResize = (() => {
      if (window.self === window.top) return () => {};
      let lastHeight = 0;
      const postHeight = () => {
        const height = document.documentElement.scrollHeight;
        if (Math.abs(height - lastHeight) < 4) return;
        lastHeight = height;
        window.parent.postMessage({ type: "retail-loss-sales-demo-resize", height }, "*");
      };
      window.addEventListener("load", () => requestAnimationFrame(postHeight));
      window.addEventListener("resize", () => requestAnimationFrame(postHeight));
      return postHeight;
    })();

    function setStatus(stateValue, label, meta) {
      DOM.statusPill.dataset.state = stateValue;
      DOM.statusPill.textContent = label;
      if (meta !== undefined) DOM.statusMeta.textContent = meta;
    }

    function formatCurrency(value, digits = 0) {
      return value.toLocaleString("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    }

    function formatNumber(value) {
      return value.toLocaleString("en-US");
    }

    function formatPercent(value, digits = 1) {
      const sign = value > 0 ? "+" : "";
      return `${sign}${value.toFixed(digits)}%`;
    }

    function parseIsoMonth(value) {
      const [year, month] = value.split("-").map((part) => Number(part));
      if (!year || !month) return null;
      const date = new Date(Date.UTC(year, month - 1, 1));
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatMonthLabel(value) {
      const date = parseIsoMonth(value);
      if (!date) return value;
      return date.toLocaleDateString("en-US", { month: "short", year: "2-digit" });
    }

    function buildMonthlySeries(weekly, metricKey) {
      const monthly = new Map();
      weekly.forEach((row) => {
        const date = new Date(row.week);
        if (Number.isNaN(date.getTime())) return;
        const key = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, "0")}`;
        const current = monthly.get(key) || 0;
        monthly.set(key, current + (row[metricKey] || 0));
      });
      return Array.from(monthly.entries())
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([month, value]) => ({ month, value }));
    }

    function sumBy(list, key) {
      return list.reduce((acc, item) => acc + (item[key] || 0), 0);
    }

    function getLatestYear(list, key) {
      let latest = 0;
      list.forEach((item) => {
        const year = Number(item[key]);
        if (year > latest) latest = year;
      });
      return latest;
    }

    function getSalesYear(data) {
      let latest = 0;
      data.monthly.forEach((row) => {
        const year = Number(row.month.split("-")[0]);
        if (year > latest) latest = year;
      });
      return latest;
    }

    function calcSalesYtd(data, year) {
      return data.monthly
        .filter((row) => Number(row.month.split("-")[0]) === year)
        .reduce((acc, row) => acc + row.sales, 0);
    }

    function calcEmptyTotal(empty) {
      return empty.monthly.reduce((acc, row) => acc + row.estimatedValue, 0);
    }

    function updateKpis() {
      const data = state.data;
      if (!data) return;
      const salesYear = getSalesYear(data.sales);
      const ytdSales = calcSalesYtd(data.sales, salesYear);
      DOM.kpiSales.textContent = formatCurrency(ytdSales, 0);
      DOM.kpiSalesSub.textContent = `Store ${data.meta.salesStore} in ${salesYear}`;

      DOM.kpiBoycott.innerHTML = data.sales.boycott.map((item) => {
        const pct = formatPercent(item.pct, 1);
        return `<span><strong>${pct}</strong> ${item.label}</span>`;
      }).join("");

      const incidentTotal = sumBy(data.incidents.stores, "incidents");
      DOM.kpiIncidents.textContent = formatNumber(Math.round(incidentTotal));
      DOM.kpiIncidentsSub.textContent = `${data.incidents.year} total incidents`;

      const shrinkYear = getLatestYear(data.inventory.years, "year");
      const shrinkItem = data.inventory.years.find((item) => item.year === shrinkYear);
      const shrinkPct = shrinkItem ? shrinkItem.avgShortagePercent * 100 : 0;
      DOM.kpiShrink.textContent = `${shrinkPct.toFixed(2)}%`;
      DOM.kpiShrinkSub.textContent = `Average in ${shrinkYear}`;

      const emptyTotal = calcEmptyTotal(data.emptyPackages);
      DOM.kpiEmpty.textContent = formatCurrency(emptyTotal, 0);

      DOM.kpiMeta.textContent = `Updated ${data.meta.generatedAt.slice(0, 10)}`;
    }

    function updateDateRangePill() {
      const data = state.data;
      if (!data) return;
      const salesMonths = data.sales.monthly.map((row) => row.month);
      const incidentMonths = data.incidents.monthly.map((row) => row.month);
      const allMonths = salesMonths.concat(incidentMonths).sort();
      const start = allMonths[0] ? formatMonthLabel(allMonths[0]) : "--";
      const end = allMonths[allMonths.length - 1] ? formatMonthLabel(allMonths[allMonths.length - 1]) : "--";
      DOM.dateRangePill.textContent = `${start} - ${end}`;
    }

    function renderDeptList() {
      const data = state.data;
      if (!data) return;
      const items = data.sales.departments;
      DOM.deptMeta.textContent = `${items.length} departments`;
      const maxValue = Math.max(...items.map((item) => item.sales), 1);
      DOM.deptList.innerHTML = items.map((item) => {
        const width = Math.max(4, (item.sales / maxValue) * 100);
        return `
          <li class="list-item">
            <div class="list-row">
              <span class="list-title">${item.department}</span>
              <span class="list-meta">${formatCurrency(item.sales, 0)}</span>
            </div>
            <div class="bar-track"><div class="bar-fill" style="width:${width}%"></div></div>
          </li>`;
      }).join("");
    }

    function renderIncidentTable(stores, metricKey) {
      const top = stores.slice(0, 6);
      const rows = top.map((item) => {
        const avgValue = formatCurrency(item.avgValue || 0, 0);
        return `
          <div class="table-row">
            <div>${item.store}</div>
            <div>${item.region || "Unknown"}</div>
            <div>${avgValue}</div>
          </div>`;
      }).join("");
      DOM.incidentTable.innerHTML = `
        <div class="table-row table-header">
          <div>Store</div>
          <div>Region</div>
          <div>Avg Value</div>
        </div>
        ${rows}`;
      const label = metricKey === "proven" ? "Top by proven value" : "Top by incidents";
      DOM.incidentMeta.textContent = label;
    }

    function renderOutliers(stores) {
      const outliers = stores.filter((item) => item.zScore > 2).slice(0, 5);
      if (!outliers.length) {
        DOM.outlierList.innerHTML = `<li class="list-item"><div class="list-row"><span class="list-title">No high outliers in selection</span></div></li>`;
        return;
      }
      DOM.outlierList.innerHTML = outliers.map((item) => {
        return `
          <li class="list-item">
            <div class="list-row">
              <span class="list-title">${item.store}</span>
              <span class="list-meta">Z ${item.zScore.toFixed(2)}</span>
            </div>
            <div class="list-row">
              <span class="list-meta">${item.region || "Unknown"}</span>
              <span class="list-meta">${formatNumber(Math.round(item.incidents))} incidents</span>
            </div>
          </li>`;
      }).join("");
    }

    function renderEmptySignals() {
      const data = state.data;
      if (!data) return;
      const metric = state.emptyMetric;
      const source = data.emptyPackages[metric] || [];
      const maxValue = Math.max(...source.map((item) => item.estimatedValue), 1);
      const labelMap = {
        employees: "associate",
        areas: "area",
        conditions: "condition"
      };
      const labelKey = labelMap[metric] || "label";
      DOM.emptyList.innerHTML = source.slice(0, 6).map((item) => {
        const width = Math.max(4, (item.estimatedValue / maxValue) * 100);
        const title = item[labelKey];
        return `
          <li class="list-item">
            <div class="list-row">
              <span class="list-title">${title}</span>
              <span class="list-meta">${formatCurrency(item.estimatedValue, 0)}</span>
            </div>
            <div class="bar-track"><div class="bar-fill" style="width:${width}%"></div></div>
            <div class="list-row">
              <span class="list-meta">${formatNumber(item.count)} items</span>
              <span class="list-meta">Avg ${formatCurrency(item.avgValue || 0, 0)}</span>
            </div>
          </li>`;
      }).join("");
      DOM.emptyNote.textContent = `Top ${metric} ranked by estimated value.`;
    }

    function updateSalesChart() {
      const data = state.data;
      if (!data) return;
      const series = buildMonthlySeries(data.sales.weekly, state.salesMetric);
      const labels = series.map((item) => formatMonthLabel(item.month));
      const values = series.map((item) => item.value);
      if (!charts.sales) {
        const ctx = document.getElementById("sales-chart").getContext("2d");
        charts.sales = new window.Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Sales",
                data: values,
                borderColor: "rgba(37, 199, 161, 0.9)",
                backgroundColor: "rgba(37, 199, 161, 0.15)",
                tension: 0.35,
                fill: true,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { color: "rgba(255, 255, 255, 0.05)" },
                ticks: { maxTicksLimit: 8 }
              },
              y: {
                grid: { color: "rgba(255, 255, 255, 0.06)" },
                ticks: {
                  callback: (value) => `$${(value / 1000000).toFixed(1)}M`
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => formatCurrency(context.parsed.y || 0, 0)
                }
              }
            }
          }
        });
      } else {
        charts.sales.data.labels = labels;
        charts.sales.data.datasets[0].data = values;
        charts.sales.update();
      }
    }

    function updateIncidentChart() {
      const data = state.data;
      if (!data) return;
      const metricKey = state.incidentMetric;
      const region = state.incidentRegion;
      const filtered = data.incidents.stores.filter((item) => {
        return region === "all" || item.region === region;
      });
      const sorted = filtered.slice().sort((a, b) => (b[metricKey] || 0) - (a[metricKey] || 0));
      const top = sorted.slice(0, 10);
      const labels = top.map((item) => item.store);
      const values = top.map((item) => item[metricKey]);

      if (!charts.incidents) {
        const ctx = document.getElementById("incident-chart").getContext("2d");
        charts.incidents = new window.Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                data: values,
                backgroundColor: "rgba(244, 178, 98, 0.7)",
                borderRadius: 8
              }
            ]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { color: "rgba(255, 255, 255, 0.05)" },
                ticks: {
                  callback: (value) => metricKey === "proven"
                    ? `$${(value / 1000000).toFixed(1)}M`
                    : value
                }
              },
              y: {
                grid: { display: false }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => metricKey === "proven"
                    ? formatCurrency(context.parsed.x || 0, 0)
                    : formatNumber(context.parsed.x || 0)
                }
              }
            }
          }
        });
      } else {
        charts.incidents.data.labels = labels;
        charts.incidents.data.datasets[0].data = values;
        charts.incidents.options.scales.x.ticks.callback = (value) => metricKey === "proven"
          ? `$${(value / 1000000).toFixed(1)}M`
          : value;
        charts.incidents.options.plugins.tooltip.callbacks.label = (context) => metricKey === "proven"
          ? formatCurrency(context.parsed.x || 0, 0)
          : formatNumber(context.parsed.x || 0);
        charts.incidents.update();
      }

      renderIncidentTable(sorted, metricKey);
      renderOutliers(sorted);
    }

    function updateShrinkChart() {
      const data = state.data;
      if (!data) return;
      const labels = data.inventory.years.map((item) => String(item.year));
      const values = data.inventory.years.map((item) => item.avgShortagePercent * 100);
      if (!charts.shrink) {
        const ctx = document.getElementById("shrink-chart").getContext("2d");
        charts.shrink = new window.Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                data: values,
                borderColor: "rgba(120, 173, 255, 0.85)",
                backgroundColor: "rgba(120, 173, 255, 0.12)",
                tension: 0.3,
                fill: true,
                pointRadius: 3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(255, 255, 255, 0.05)" },
                ticks: { callback: (value) => `${value.toFixed(2)}%` }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.y.toFixed(2)}%`
                }
              }
            }
          }
        });
      } else {
        charts.shrink.data.labels = labels;
        charts.shrink.data.datasets[0].data = values;
        charts.shrink.update();
      }
      const latest = data.inventory.year;
      DOM.shrinkMeta.textContent = `${latest} avg shortage percent`;
    }

    function initRegionFilter() {
      const data = state.data;
      if (!data) return;
      const regions = Array.from(new Set(data.incidents.stores.map((item) => item.region).filter(Boolean))).sort();
      regions.forEach((region) => {
        const opt = document.createElement("option");
        opt.value = region;
        opt.textContent = region;
        DOM.incidentRegion.appendChild(opt);
      });
    }

    function bindControls() {
      DOM.salesButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const metric = btn.dataset.salesMetric;
          state.salesMetric = metric;
          DOM.salesButtons.forEach((button) => button.classList.toggle("is-active", button === btn));
          updateSalesChart();
        });
      });

      DOM.incidentButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const metric = btn.dataset.incidentMetric;
          state.incidentMetric = metric;
          DOM.incidentButtons.forEach((button) => button.classList.toggle("is-active", button === btn));
          updateIncidentChart();
        });
      });

      DOM.emptyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const metric = btn.dataset.emptyMetric;
          state.emptyMetric = metric;
          DOM.emptyButtons.forEach((button) => button.classList.toggle("is-active", button === btn));
          renderEmptySignals();
        });
      });

      DOM.incidentRegion.addEventListener("change", (event) => {
        state.incidentRegion = event.target.value;
        updateIncidentChart();
      });

      DOM.resetFilters.addEventListener("click", () => {
        state.salesMetric = "sales";
        state.incidentMetric = "incidents";
        state.incidentRegion = "all";
        state.emptyMetric = "employees";
        DOM.incidentRegion.value = "all";
        DOM.salesButtons.forEach((button) => button.classList.toggle("is-active", button.dataset.salesMetric === "sales"));
        DOM.incidentButtons.forEach((button) => button.classList.toggle("is-active", button.dataset.incidentMetric === "incidents"));
        DOM.emptyButtons.forEach((button) => button.classList.toggle("is-active", button.dataset.emptyMetric === "employees"));
        updateSalesChart();
        updateIncidentChart();
        renderEmptySignals();
      });
    }

    async function loadData() {
      if (!API_URL) {
        setStatus("err", "Unavailable", "API endpoint missing");
        return;
      }
      setStatus("warming", "Connecting", "Fetching AWS data...");
      try {
        const data = await getJson(joinUrl(API_URL, "data"), { cache: "no-store" });
        state.data = data;
        setStatus("ok", "Ready", "Anonymized data loaded");
        updateDateRangePill();
        updateKpis();
        renderDeptList();
        initRegionFilter();
        updateSalesChart();
        updateIncidentChart();
        updateShrinkChart();
        renderEmptySignals();
        bindControls();
        notifyResize();
      } catch (err) {
        setStatus("err", "Unavailable", "Unable to load demo data");
        DOM.dateRangePill.textContent = "--";
      }
    }

    loadData();
  </script>
</body>
</html>
