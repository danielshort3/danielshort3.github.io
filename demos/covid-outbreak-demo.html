<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <base href="/">
  <title>COVID Outbreak Drivers Demo</title>
  <meta name="theme-color" content="#0D1117" />
  <link rel="stylesheet" href="dist/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600&display=swap">
  <style>
    :root {
      --radius-lg: 18px;
      --radius-md: 14px;
      --page-pad: clamp(12px, 3vw, 24px);
      --shadow-1: 0 2px 10px rgba(0,0,0,.06), 0 1px 4px rgba(0,0,0,.06);
      --shadow-2: 0 8px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      --surface-2: var(--surface-light);
      --surface-3: color-mix(in srgb, var(--surface) 88%, #000 12%);
      --text: var(--text-light);
      --muted: var(--text-muted);
      --accent: var(--primary);
      --accent-2: color-mix(in srgb, var(--primary) 60%, #6fe0d6 40%);
      --border: var(--surface-accent);
      --risk-low: var(--success);
      --risk-elevated: var(--warning);
      --risk-high: var(--danger);
      --risk-none: color-mix(in srgb, var(--surface) 70%, #ffffff 30%);
      --map-bg: color-mix(in srgb, var(--surface) 45%, #ffffff 55%);
      --map-border: color-mix(in srgb, var(--surface) 30%, #ffffff 70%);
      --map-text: #0D1117;
      --map-line: color-mix(in srgb, var(--map-text) 70%, #ffffff 30%);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    html[data-embedded="true"],
    html[data-embedded="true"] body {
      height: auto !important;
      min-height: 0 !important;
    }
    html[data-embedded="true"] {
      --page-pad: clamp(8px, 2vw, 16px);
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 50% -10%, color-mix(in srgb, var(--primary) 15%, transparent), transparent 60%)
        var(--bg);
      display: grid;
      place-items: start center;
      padding: var(--page-pad);
      overflow-x: hidden;
    }

    #demo-box {
      width: min(1200px, 100%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto auto 1fr;
      min-height: calc(100vh - var(--page-pad) * 2);
      animation: rise 0.6s ease both;
    }

    @supports (height: 100dvh) {
      #demo-box {
        min-height: calc(100dvh - var(--page-pad) * 2 - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
    }

    html[data-embedded="true"] #demo-box {
      min-height: 0 !important;
    }

    header.card-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 18px;
      background: linear-gradient(0deg, var(--surface), var(--surface-2));
      border-bottom: 1px solid var(--border);
    }

    .header-copy {
      display: grid;
      gap: 6px;
      min-width: 0;
    }

    .title {
      margin: 0;
      font-family: Poppins, Inter, system-ui, sans-serif;
      font-weight: 600;
      font-size: clamp(1.1rem, 2.2vw, 1.35rem);
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      max-width: 60ch;
    }

    .health-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 8px 16px 0;
    }

    .health-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      color: var(--muted);
      background: var(--surface-2);
    }

    .health-pill::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .health-pill[data-state="ok"] {
      color: var(--success, #38b37e);
      border-color: color-mix(in srgb, var(--success, #38b37e) 55%, var(--border) 45%);
    }

    .health-pill[data-state="warming"] {
      color: var(--warning, #f3b550);
      border-color: color-mix(in srgb, var(--warning, #f3b550) 55%, var(--border) 45%);
    }

    .health-pill[data-state="err"] {
      color: var(--danger, #e05757);
      border-color: color-mix(in srgb, var(--danger, #e05757) 55%, var(--border) 45%);
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 18px 12px;
      border-bottom: 1px solid var(--border);
    }

    .status-meta {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .content {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 22px;
      padding: 20px 22px 24px;
    }

    .panel {
      background: color-mix(in srgb, var(--surface) 92%, #000 8%);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 16px;
      display: grid;
      gap: 16px;
      min-height: 0;
    }

    .panel h2,
    .panel h3 {
      margin: 0;
      font-family: Poppins, Inter, system-ui, sans-serif;
      font-weight: 600;
    }

    .map-wrap {
      display: grid;
      gap: 14px;
      position: relative;
    }

    .map-wrap[data-ready="false"] {
      opacity: 0.65;
    }

    .map-wrap[data-ready="false"] .map-svg {
      pointer-events: none;
      filter: grayscale(0.2);
    }

    .map-svg {
      position: relative;
      background: var(--map-bg);
      border: 1px solid var(--map-border);
      border-radius: 16px;
      padding: 8px;
      overflow: hidden;
      min-height: clamp(280px, 45vw, 420px);
    }

    #map-svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .state-shape {
      fill: color-mix(in srgb, var(--map-bg) 82%, var(--surface) 18%);
      cursor: pointer;
      transition: fill 0.2s ease, filter 0.2s ease;
    }

    .state-shape:hover {
      filter: brightness(1.04);
    }

    .state-shape[data-risk="low"] {
      fill: color-mix(in srgb, var(--risk-low) 70%, var(--map-bg) 30%);
    }

    .state-shape[data-risk="elevated"] {
      fill: color-mix(in srgb, var(--risk-elevated) 70%, var(--map-bg) 30%);
    }

    .state-shape[data-risk="high"] {
      fill: color-mix(in srgb, var(--risk-high) 72%, var(--map-bg) 28%);
    }

    .state-shape[data-risk="unknown"] {
      fill: color-mix(in srgb, var(--map-bg) 78%, var(--surface) 22%);
    }

    .state-shape[data-active="true"] {
      filter: drop-shadow(0 6px 10px rgba(32, 26, 20, 0.25));
    }

    .state-shape:focus-visible {
      filter: drop-shadow(0 0 6px rgba(32, 26, 20, 0.35));
      outline: none;
    }

    .state-border {
      fill: none;
      stroke: var(--map-border);
      stroke-width: 1;
      vector-effect: non-scaling-stroke;
      pointer-events: none;
    }

    .state-label,
    .state-leader {
      pointer-events: none;
    }

    .state-label {
      font-size: 10px;
      font-weight: 600;
      fill: var(--map-text);
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
    }

    .state-label[data-outside="true"] {
      fill: var(--map-text);
      font-size: 11px;
    }

    .state-leader {
      stroke: var(--map-line);
      stroke-width: 1;
      opacity: 0.75;
    }

    .map-tooltip {
      position: absolute;
      pointer-events: none;
      background: color-mix(in srgb, var(--map-bg) 92%, #ffffff 8%);
      color: var(--map-text);
      font-size: 0.75rem;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--map-border);
      opacity: 0;
      transform: translate(-50%, -6px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      white-space: nowrap;
      z-index: 5;
    }

    .map-tooltip.visible {
      opacity: 1;
      transform: translate(-50%, -10px);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .map-legend {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .map-legend .key {
      justify-content: center;
      width: 100%;
      text-align: center;
    }

    .legend .key {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend .swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .controls {
      display: grid;
      gap: 10px;
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .date-display {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .timeline-ticks {
      position: relative;
      height: 18px;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .timeline-tick {
      position: absolute;
      top: 0;
      transform: translateX(-50%);
      display: grid;
      justify-items: center;
      gap: 2px;
      white-space: nowrap;
    }

    .timeline-tick::before {
      content: "";
      width: 1px;
      height: 6px;
      background: var(--border);
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .risk-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid transparent;
    }

    .risk-pill[data-risk="low"] {
      background: color-mix(in srgb, var(--risk-low) 18%, transparent);
      color: color-mix(in srgb, var(--risk-low) 72%, #ffffff 28%);
      border-color: color-mix(in srgb, var(--risk-low) 40%, transparent);
    }

    .risk-pill[data-risk="elevated"] {
      background: color-mix(in srgb, var(--risk-elevated) 18%, transparent);
      color: color-mix(in srgb, var(--risk-elevated) 72%, #ffffff 28%);
      border-color: color-mix(in srgb, var(--risk-elevated) 40%, transparent);
    }

    .risk-pill[data-risk="high"] {
      background: color-mix(in srgb, var(--risk-high) 18%, transparent);
      color: color-mix(in srgb, var(--risk-high) 72%, #ffffff 28%);
      border-color: color-mix(in srgb, var(--risk-high) 40%, transparent);
    }

    .risk-pill[data-risk="unknown"] {
      background: color-mix(in srgb, var(--risk-none) 22%, transparent);
      color: var(--muted);
      border-color: color-mix(in srgb, var(--risk-none) 45%, transparent);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .metric {
      padding: 12px;
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      display: grid;
      gap: 6px;
    }

    .metric-label {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .metric-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .drivers {
      display: grid;
      gap: 10px;
    }

    .drivers ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }

    .drivers li {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 0.82rem;
    }

    .drivers .driver-label {
      color: var(--text);
      font-weight: 600;
    }

    .drivers .driver-value {
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }

    .trend {
      background: var(--surface);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .trend svg {
      width: 100%;
      height: 140px;
    }

    .trend .legend {
      justify-content: flex-start;
      gap: 14px;
    }

    .hotspots {
      display: grid;
      gap: 12px;
    }

    .hotspots ol {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      color: var(--muted);
      font-size: 0.86rem;
    }

    .hotspots li {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .hotspots .hotspot-score {
      font-weight: 600;
      color: var(--text);
    }

    .territories {
      display: grid;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .territories ul {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 6px;
    }

    .territories li {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .empty-note {
      color: var(--muted);
      font-size: 0.82rem;
    }

    @media (max-width: 980px) {
      .content {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .metrics {
        grid-template-columns: 1fr;
      }

      .map-svg {
        min-height: 260px;
      }
    }

    @media (max-width: 520px) {
      :root {
        --page-pad: 10px;
      }
      header.card-header {
        padding: 14px 16px 12px;
      }
      .status-row {
        padding: 8px 16px;
        flex-wrap: wrap;
      }
      .content {
        padding: 16px;
      }
      .panel {
        padding: 12px;
      }
      .detail-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .legend {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .control-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .drivers li {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(14px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.98);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
  <script>
    if (window.self !== window.top) {
      document.documentElement.setAttribute("data-embedded", "true");
    }
  </script>
</head>
<body>
  <div id="demo-box" role="application" aria-label="COVID outbreak drivers demo">
    <header class="card-header">
      <div class="header-copy">
        <h1 class="title">COVID Outbreak Drivers</h1>
        <p class="subtitle">Explore 7-day ICU breach risk by state with SHAP-inspired drivers. Move the date slider to surface emerging hotspots.</p>
      </div>
    </header>

    <div class="health-row" role="status" aria-live="polite">
      <span class="health-pill" id="connection-pill" data-state="warming">Warming up</span>
    </div>
    <div class="status-row">
      <span class="status-meta" id="connection-meta">Connecting to AWS Lambda</span>
    </div>

    <div class="content">
      <section class="panel">
        <div class="map-wrap" id="map-wrap" data-ready="false">
          <div class="control-row">
            <div>
              <h2>Risk Map</h2>
              <div class="empty-note">Hover a state for a quick readout.</div>
            </div>
            <div class="date-display" id="date-value">--</div>
          </div>
          <div class="legend map-legend" aria-label="Risk legend">
            <span class="key"><span class="swatch" style="background:var(--risk-low)"></span> Low (&lt;5%)</span>
            <span class="key"><span class="swatch" style="background:var(--risk-elevated)"></span> Elevated (5-15%)</span>
            <span class="key"><span class="swatch" style="background:var(--risk-high)"></span> High (15%+)</span>
          </div>
          <div class="map-svg">
            <svg id="map-svg" viewBox="0 0 975 610" preserveAspectRatio="xMidYMid meet" role="list" aria-label="State risk map"></svg>
          </div>
          <div class="map-tooltip" id="map-tooltip" role="tooltip"></div>
        </div>

        <div class="controls">
          <div class="control-row">
            <div class="empty-note" id="date-range">Range: --</div>
            <div class="empty-note" id="date-selected">Selected: --</div>
          </div>
          <input id="date-slider" type="range" min="0" max="0" value="0" step="1" aria-label="Date slider" />
        </div>
      </section>

      <section class="panel">
        <div class="detail-header">
          <h2 id="state-title">Select a state</h2>
          <span class="risk-pill" id="risk-pill" data-risk="unknown">No data</span>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="metric-label">7-day breach probability</div>
            <div class="metric-value" id="prob-value">--</div>
          </div>
          <div class="metric">
            <div class="metric-label">Adult ICU utilization</div>
            <div class="metric-value" id="icu-value">--</div>
          </div>
        </div>

        <div class="drivers">
          <h3>Top drivers</h3>
          <ul id="drivers-list"></ul>
        </div>

        <div class="trend">
          <h3>Recent trend (45 days)</h3>
          <svg id="trend-chart" viewBox="0 0 360 140" preserveAspectRatio="none"></svg>
          <div class="legend">
            <span class="key"><span class="swatch" style="background:var(--accent)"></span> Risk</span>
            <span class="key"><span class="swatch" style="background:var(--accent-2)"></span> ICU</span>
          </div>
        </div>

        <div class="hotspots">
          <h3>Top hotspots</h3>
          <ol id="hotspots-list"></ol>
        </div>

        <div class="territories" id="territories-panel">
          <h3>Territories</h3>
          <ul id="territories-list"></ul>
        </div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-composite-projections@1/dist/d3-composite-projections.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="js/demos/aws-client.js"></script>
  <script type="module">
    const DEFAULT_API_URL = "https://lv4inwnj6yyo3kfdajpk2v5eda0hrtao.lambda-url.us-east-2.on.aws/";
    const STORAGE_KEY = "demo.endpoint.covid";
    const LEGACY_KEYS = ["covid_outbreak_api"];
    const { resolveEndpoint, getJson, joinUrl } = window.DemoAws;

    const notifyResize = (() => {
      const CHANNEL = "covid-outbreak-demo-resize";
      const calcHeight = () => {
        const doc = document.documentElement;
        const body = document.body || doc;
        return Math.ceil(Math.max(
          body.scrollHeight,
          body.offsetHeight,
          doc.clientHeight,
          doc.scrollHeight,
          doc.offsetHeight
        ));
      };
      const postHeight = () => {
        try { parent.postMessage({ type: CHANNEL, height: calcHeight() }, "*"); } catch (err) {}
      };
      window.addEventListener("load", postHeight);
      try { document.fonts?.ready?.then(postHeight); } catch (err) {}
      if ("ResizeObserver" in window) {
        const ro = new ResizeObserver(() => postHeight());
        ro.observe(document.documentElement);
      } else {
        let prev = 0;
        setInterval(() => {
          const h = calcHeight();
          if (Math.abs(h - prev) > 4) {
            prev = h;
            postHeight();
          }
        }, 750);
      }
      return postHeight;
    })();

    const MAP_DATA_URL = "js/maps/us-states-10m.json";
    const NAME_TO_ABBR = {
      "Alabama": "AL",
      "Alaska": "AK",
      "Arizona": "AZ",
      "Arkansas": "AR",
      "California": "CA",
      "Colorado": "CO",
      "Connecticut": "CT",
      "Delaware": "DE",
      "District of Columbia": "DC",
      "Florida": "FL",
      "Georgia": "GA",
      "Hawaii": "HI",
      "Idaho": "ID",
      "Illinois": "IL",
      "Indiana": "IN",
      "Iowa": "IA",
      "Kansas": "KS",
      "Kentucky": "KY",
      "Louisiana": "LA",
      "Maine": "ME",
      "Maryland": "MD",
      "Massachusetts": "MA",
      "Michigan": "MI",
      "Minnesota": "MN",
      "Mississippi": "MS",
      "Missouri": "MO",
      "Montana": "MT",
      "Nebraska": "NE",
      "Nevada": "NV",
      "New Hampshire": "NH",
      "New Jersey": "NJ",
      "New Mexico": "NM",
      "New York": "NY",
      "North Carolina": "NC",
      "North Dakota": "ND",
      "Ohio": "OH",
      "Oklahoma": "OK",
      "Oregon": "OR",
      "Pennsylvania": "PA",
      "Rhode Island": "RI",
      "South Carolina": "SC",
      "South Dakota": "SD",
      "Tennessee": "TN",
      "Texas": "TX",
      "Utah": "UT",
      "Vermont": "VT",
      "Virginia": "VA",
      "Washington": "WA",
      "West Virginia": "WV",
      "Wisconsin": "WI",
      "Wyoming": "WY",
      "American Samoa": "AS",
      "Guam": "GU",
      "Commonwealth of the Northern Mariana Islands": "MP",
      "Puerto Rico": "PR",
      "United States Virgin Islands": "VI",
      "U.S. Virgin Islands": "VI"
    };

    const SMALL_STATES = new Set([
      "VT", "NH", "MA", "RI", "CT", "NJ", "DE", "MD", "DC", "ME", "HI", "PR", "VI", "AS", "GU", "MP"
    ]);

    const LABEL_OFFSETS = {
      VT: [18, -8],
      NH: [18, -16],
      MA: [22, -6],
      RI: [22, 8],
      CT: [22, 4],
      NJ: [18, 14],
      DE: [18, 22],
      MD: [18, 30],
      DC: [18, 38],
      ME: [18, -22],
      HI: [16, 10],
      PR: [18, 6],
      VI: [18, 14],
      AS: [18, 10],
      GU: [18, 4],
      MP: [18, -6]
    };

    const DOM = {
      mapWrap: document.getElementById("map-wrap"),
      mapSvg: document.getElementById("map-svg"),
      tooltip: document.getElementById("map-tooltip"),
      connectionPill: document.getElementById("connection-pill"),
      connectionMeta: document.getElementById("connection-meta"),
      dateValue: document.getElementById("date-value"),
      dateRange: document.getElementById("date-range"),
      dateSelected: document.getElementById("date-selected"),
      dateSlider: document.getElementById("date-slider"),
      timelineTicks: document.getElementById("timeline-ticks"),
      stateTitle: document.getElementById("state-title"),
      riskPill: document.getElementById("risk-pill"),
      probValue: document.getElementById("prob-value"),
      icuValue: document.getElementById("icu-value"),
      driversList: document.getElementById("drivers-list"),
      hotspotsList: document.getElementById("hotspots-list"),
      territoriesPanel: document.getElementById("territories-panel"),
      territoriesList: document.getElementById("territories-list"),
      trendChart: document.getElementById("trend-chart")
    };

    const cache = {
      byDate: new Map(),
      state: new Map()
    };

    const appState = {
      dates: [],
      activeDate: null,
      states: new Map(),
      activeState: null,
      endpoint: null,
      meta: null
    };
    let serverReady = false;

    const numberFormat = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
    const dateFormatter = new Intl.DateTimeFormat("en-US", { year: "numeric", month: "short", day: "numeric" });

    const endpointConfig = {
      defaultUrl: DEFAULT_API_URL,
      storageKey: STORAGE_KEY,
      legacyKeys: LEGACY_KEYS
    };

    function setConnection(state, text) {
      DOM.connectionPill.dataset.state = state;
      DOM.connectionPill.textContent = text;
    }

    function setServerReady(ready) {
      serverReady = ready;
      if (DOM.mapWrap) {
        DOM.mapWrap.dataset.ready = ready ? 'true' : 'false';
      }
      if (DOM.dateSlider) {
        DOM.dateSlider.disabled = !ready;
      }
    }

    async function fetchJson(path) {
      return getJson(joinUrl(appState.endpoint, path));
    }

    function formatPercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return "--";
      }
      return `${(value * 100).toFixed(1)}%`;
    }

    function formatCount(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return "--";
      }
      return numberFormat.format(Math.round(value));
    }

    function formatRisk(risk) {
      if (risk === "high") return "High";
      if (risk === "elevated") return "Elevated";
      if (risk === "low") return "Low";
      return "No data";
    }

    function formatDateLabel(dateStr) {
      if (!dateStr) return "--";
      const parts = String(dateStr).split("-").map(Number);
      if (parts.length !== 3) return dateStr;
      const [year, month, day] = parts;
      if (!year || !month || !day) return dateStr;
      const date = new Date(Date.UTC(year, month - 1, day));
      return dateFormatter.format(date);
    }

    async function renderMap() {
      if (!window.d3 || !window.topojson) {
        throw new Error("Map libraries unavailable");
      }
      const res = await fetch(MAP_DATA_URL);
      if (!res.ok) {
        throw new Error(`Map data failed: ${res.status}`);
      }
      const topo = await res.json();
      const features = topojson.feature(topo, topo.objects.states).features
        .filter((feature) => NAME_TO_ABBR[feature.properties.name]);
      const width = 975;
      const height = 610;
      const projectionFactory = d3.geoAlbersUsaTerritories || d3.geoAlbersUsa;
      const projection = projectionFactory().fitSize([width, height], {
        type: "FeatureCollection",
        features
      });
      const path = d3.geoPath(projection);
      const svg = d3.select(DOM.mapSvg);
      svg.selectAll("*").remove();
      svg.append("g")
        .selectAll("path")
        .data(features)
        .enter()
        .append("path")
        .attr("class", "state-shape")
        .attr("d", path)
        .attr("data-state", (d) => NAME_TO_ABBR[d.properties.name] || "")
        .attr("tabindex", (d) => NAME_TO_ABBR[d.properties.name] ? "0" : null)
        .attr("role", (d) => NAME_TO_ABBR[d.properties.name] ? "button" : null)
        .attr("aria-label", (d) => d.properties.name || "")
        .on("mouseenter", (event, d) => showTooltip(event, NAME_TO_ABBR[d.properties.name]))
        .on("mouseleave", hideTooltip)
        .on("focus", (event, d) => showTooltip(event, NAME_TO_ABBR[d.properties.name]))
        .on("blur", hideTooltip)
        .on("click", (event, d) => {
          const stateId = NAME_TO_ABBR[d.properties.name];
          if (stateId) selectState(stateId);
        })
        .on("keydown", (event, d) => {
          if (event.key !== "Enter" && event.key !== " ") return;
          event.preventDefault();
          const stateId = NAME_TO_ABBR[d.properties.name];
          if (stateId) selectState(stateId);
        });
      const borders = topojson.mesh(topo, topo.objects.states);
      svg.append("path")
        .attr("class", "state-border")
        .attr("d", path(borders));
      const leaderLayer = svg.append("g").attr("class", "state-leaders");
      const labelLayer = svg.append("g").attr("class", "state-labels");
      features.forEach((feature) => {
        const stateId = NAME_TO_ABBR[feature.properties.name];
        if (!stateId) return;
        const bounds = path.bounds(feature);
        const centroid = path.centroid(feature);
        if (!Number.isFinite(centroid[0]) || !Number.isFinite(centroid[1])) return;
        if (!Number.isFinite(bounds[0][0]) || !Number.isFinite(bounds[0][1]) ||
            !Number.isFinite(bounds[1][0]) || !Number.isFinite(bounds[1][1])) return;
        const w = bounds[1][0] - bounds[0][0];
        const h = bounds[1][1] - bounds[0][1];
        const area = w * h;
        const isSmall = SMALL_STATES.has(stateId) || area < 700 || w < 26 || h < 18;
        let labelX = centroid[0];
        let labelY = centroid[1];
        let anchor = "middle";
        let outside = "false";
        if (isSmall) {
          const fallbackOffset = (() => {
            const dx = centroid[0] > width * 0.65 ? -24 : 24;
            const dy = centroid[1] < height * 0.25 ? -16 : (centroid[1] > height * 0.78 ? 16 : 0);
            return [dx, dy];
          })();
          const offset = LABEL_OFFSETS[stateId] || fallbackOffset;
          labelX = centroid[0] + offset[0];
          labelY = centroid[1] + offset[1];
          anchor = offset[0] < 0 ? "end" : "start";
          outside = "true";
        }
        if (!Number.isFinite(labelX) || !Number.isFinite(labelY)) return;
        if (isSmall) {
          const leader = document.createElementNS("http://www.w3.org/2000/svg", "line");
          leader.setAttribute("class", "state-leader");
          leader.setAttribute("data-state", stateId);
          leader.setAttribute("x1", centroid[0]);
          leader.setAttribute("y1", centroid[1]);
          leader.setAttribute("x2", labelX);
          leader.setAttribute("y2", labelY);
          leaderLayer.node().appendChild(leader);
        }
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("class", "state-label");
        label.setAttribute("data-state", stateId);
        label.setAttribute("data-outside", outside);
        label.setAttribute("x", labelX);
        label.setAttribute("y", labelY);
        label.setAttribute("text-anchor", anchor);
        label.setAttribute("dominant-baseline", "middle");
        label.textContent = "--";
        labelLayer.node().appendChild(label);
      });
      notifyResize();
    }

    function showTooltip(event, stateId) {
      if (!stateId) return;
      const data = appState.states.get(stateId);
      const name = data?.name || stateId;
      const value = data ? formatPercent(data.prob) : "--";
      const tooltip = DOM.tooltip;
      tooltip.textContent = `${name}: ${value}`;
      const rect = event.currentTarget.getBoundingClientRect();
      const wrapRect = DOM.mapWrap.getBoundingClientRect();
      tooltip.style.left = `${rect.left - wrapRect.left + rect.width / 2}px`;
      tooltip.style.top = `${rect.top - wrapRect.top}px`;
      tooltip.classList.add("visible");
    }

    function hideTooltip() {
      DOM.tooltip.classList.remove("visible");
    }

    function updateMap() {
      if (!DOM.mapSvg) return;
      const shapes = DOM.mapSvg.querySelectorAll(".state-shape");
      shapes.forEach((shape) => {
        const stateId = shape.dataset.state;
        if (!stateId) return;
        const data = appState.states.get(stateId);
        const risk = data ? data.risk : "unknown";
        shape.dataset.risk = risk || "unknown";
        shape.dataset.active = appState.activeState === stateId;
        shape.setAttribute("aria-label", data ? `${data.name} ${formatPercent(data.prob)}` : stateId);
      });
      updateLabels();
    }

    function updateLabels() {
      const labels = DOM.mapSvg.querySelectorAll(".state-label");
      labels.forEach((label) => {
        const stateId = label.dataset.state;
        const data = appState.states.get(stateId);
        label.textContent = data ? formatPercent(data.prob) : "--";
        label.dataset.risk = data ? data.risk : "unknown";
      });
    }

    function updateHotspots(list) {
      if (!Array.isArray(list) || list.length === 0) {
        DOM.hotspotsList.innerHTML = "<li>No data</li>";
        return;
      }
      const items = list.slice(0, 5);
      while (items.length < 5) {
        items.push({ name: "No data", prob: null });
      }
      DOM.hotspotsList.innerHTML = items.map((item) => {
        return `<li><span>${item.name}</span><span class="hotspot-score">${formatPercent(item.prob)}</span></li>`;
      }).join("");
    }

    function updateTerritories(states) {
      const territories = states.filter((item) => !item.inMap);
      if (!territories.length) {
        DOM.territoriesPanel.style.display = "none";
        return;
      }
      DOM.territoriesPanel.style.display = "grid";
      DOM.territoriesList.innerHTML = territories.map((item) => {
        return `<li><span>${item.name}</span><span>${formatPercent(item.prob)}</span></li>`;
      }).join("");
    }

    function updateDrivers(drivers) {
      if (!drivers || !drivers.length) {
        DOM.driversList.innerHTML = "<li class=\"empty-note\">No drivers available</li>";
        return;
      }
      DOM.driversList.innerHTML = drivers.map((driver) => {
        const value = driver.format === "pct" ? formatPercent(driver.value) : formatCount(driver.value);
        return `<li><span class=\"driver-label\">${driver.label}</span><span class=\"driver-value\">${value}</span></li>`;
      }).join("");
    }

    function updateTrend(history) {
      const svg = DOM.trendChart;
      svg.innerHTML = "";
      if (!history || history.length === 0) {
        svg.innerHTML = "<text x=\"16\" y=\"24\" fill=\"var(--text-muted)\" font-size=\"12\">No history available</text>";
        return;
      }
      const slice = history.slice(-45);
      const width = 360;
      const height = 140;
      const chart = { top: 10, right: 12, bottom: 24, left: 44 };
      const maxX = Math.max(1, slice.length - 1);
      const clamp = (val) => Math.max(0, Math.min(1, Number.isFinite(val) ? val : 0));
      const probValues = slice.map((d) => clamp(d.prob));
      const icuValues = slice.map((d) => clamp(d.icuUtilization));
      const yScale = (val) => {
        const span = height - chart.top - chart.bottom;
        return chart.top + (1 - clamp(val)) * span;
      };
      const xScale = (idx) => {
        const span = width - chart.left - chart.right;
        return chart.left + (idx / maxX) * span;
      };

      function buildPath(values) {
        return values.map((val, idx) => {
          const x = xScale(idx);
          const y = yScale(val);
          return `${idx === 0 ? "M" : "L"}${x.toFixed(1)},${y.toFixed(1)}`;
        }).join(" ");
      }

      const axisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
      axisLine.setAttribute("x1", chart.left);
      axisLine.setAttribute("x2", chart.left);
      axisLine.setAttribute("y1", chart.top);
      axisLine.setAttribute("y2", height - chart.bottom);
      axisLine.setAttribute("stroke", "var(--border)");
      axisLine.setAttribute("stroke-width", "1");
      svg.appendChild(axisLine);

      [0, 0.25, 0.5, 0.75, 1].forEach((tick, idx) => {
        const y = yScale(tick);
        const grid = document.createElementNS("http://www.w3.org/2000/svg", "line");
        grid.setAttribute("x1", chart.left);
        grid.setAttribute("x2", width - chart.right);
        grid.setAttribute("y1", y);
        grid.setAttribute("y2", y);
        grid.setAttribute("stroke", "var(--border)");
        grid.setAttribute("stroke-width", "1");
        if (tick !== 0) grid.setAttribute("stroke-dasharray", "3 4");
        svg.appendChild(grid);

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", chart.left - 6);
        label.setAttribute("y", y + 4);
        label.setAttribute("fill", "var(--text-muted)");
        label.setAttribute("font-size", "11");
        label.setAttribute("text-anchor", "end");
        label.textContent = `${Math.round(tick * 100)}%`;
        svg.appendChild(label);
      });

      const probPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
      probPath.setAttribute("d", buildPath(probValues));
      probPath.setAttribute("fill", "none");
      probPath.setAttribute("stroke", "var(--accent)");
      probPath.setAttribute("stroke-width", "2.5");
      probPath.setAttribute("stroke-linecap", "round");
      svg.appendChild(probPath);

      const icuPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
      icuPath.setAttribute("d", buildPath(icuValues));
      icuPath.setAttribute("fill", "none");
      icuPath.setAttribute("stroke", "var(--accent-2)");
      icuPath.setAttribute("stroke-width", "2");
      icuPath.setAttribute("stroke-linecap", "round");
      icuPath.setAttribute("stroke-dasharray", "5 4");
      svg.appendChild(icuPath);
    }

    async function loadStateHistory(stateId) {
      if (cache.state.has(stateId)) {
        return cache.state.get(stateId);
      }
      try {
        const data = await fetchJson(`state/${stateId}`);
        cache.state.set(stateId, data);
        return data;
      } catch (err) {
        console.warn(err);
        return null;
      }
    }

    function selectState(stateId) {
      if (!serverReady) return;
      appState.activeState = stateId;
      updateMap();
      const data = appState.states.get(stateId);
      if (!data) {
        DOM.stateTitle.textContent = "No data";
        DOM.riskPill.dataset.risk = "unknown";
        DOM.riskPill.textContent = "No data";
        DOM.probValue.textContent = "--";
        DOM.icuValue.textContent = "--";
        updateDrivers([]);
        updateTrend([]);
        return;
      }
      DOM.stateTitle.textContent = data.name;
      DOM.riskPill.dataset.risk = data.risk || "unknown";
      DOM.riskPill.textContent = formatRisk(data.risk);
      DOM.probValue.textContent = formatPercent(data.prob);
      DOM.icuValue.textContent = formatPercent(data.icuUtilization);
      updateDrivers(data.drivers);
      loadStateHistory(stateId).then((payload) => {
        updateTrend(payload ? payload.history : []);
      });
    }

    async function loadDate(dateStr) {
      if (cache.byDate.has(dateStr)) {
        return cache.byDate.get(dateStr);
      }
      const data = await fetchJson(`states?date=${dateStr}`);
      cache.byDate.set(dateStr, data);
      return data;
    }

    function syncDateUI(index) {
      const date = appState.dates[index];
      if (!date) return;
      const displayDate = formatDateLabel(date);
      const startDate = formatDateLabel(appState.dates[0]);
      const endDate = formatDateLabel(appState.dates[appState.dates.length - 1]);
      DOM.dateValue.textContent = displayDate;
      if (DOM.dateSelected) {
        DOM.dateSelected.textContent = `Selected: ${displayDate}`;
      }
      DOM.dateRange.textContent = `Range: ${startDate} â€” ${endDate}`;
    }

    function updateYearTicks(dates) {
      if (!DOM.timelineTicks) return;
      if (!Array.isArray(dates) || dates.length === 0) {
        DOM.timelineTicks.innerHTML = "";
        return;
      }
      const firstIndexByYear = new Map();
      dates.forEach((date, idx) => {
        const year = String(date).slice(0, 4);
        if (!firstIndexByYear.has(year)) {
          firstIndexByYear.set(year, idx);
        }
      });
      const maxIndex = Math.max(1, dates.length - 1);
      DOM.timelineTicks.innerHTML = Array.from(firstIndexByYear.entries()).map(([year, idx]) => {
        const left = ((idx / maxIndex) * 100).toFixed(2);
        return `<span class=\"timeline-tick\" style=\"left:${left}%\">${year}</span>`;
      }).join("");
    }

    async function handleDateChange(index) {
      if (!serverReady) return;
      const date = appState.dates[index];
      if (!date) return;
      appState.activeDate = date;
      syncDateUI(index);
      const payload = await loadDate(date);
      appState.states = new Map(payload.states.map((item) => [item.id, item]));
      updateMap();
      updateHotspots(payload.hotspots);
      updateTerritories(payload.states);
      if (!appState.activeState) {
        const mappedHotspot = payload.hotspots?.find((item) => appState.states.get(item.id)?.inMap);
        const mappedState = payload.states?.find((item) => item.inMap);
        selectState((mappedHotspot || mappedState || payload.states?.[0])?.id);
      } else {
        selectState(appState.activeState);
      }
    }

    async function init() {
      appState.endpoint = resolveEndpoint(endpointConfig);
      setServerReady(false);
      setConnection("warming", "Warming up");
      DOM.connectionMeta.textContent = "Warming AWS Lambda";
      try {
        await renderMap();
      } catch (err) {
        console.error(err);
        DOM.connectionMeta.textContent = "Map assets unavailable.";
      }
      try {
        const meta = await fetchJson("meta");
        appState.meta = meta;
        appState.dates = meta.dates || [];
        if (!appState.dates.length) {
          throw new Error("No dates available");
        }
        updateYearTicks(appState.dates);
        const latestIdx = appState.dates.length - 1;
        DOM.dateSlider.max = String(latestIdx);
        DOM.dateSlider.value = String(latestIdx);
        setServerReady(true);
        setConnection("ok", "Ready");
        DOM.connectionMeta.textContent = "Live data loaded from AWS";
        DOM.dateSlider.addEventListener("input", (event) => {
          handleDateChange(Number(event.target.value));
        });
        await handleDateChange(latestIdx);
      } catch (err) {
        console.error(err);
        setServerReady(false);
        setConnection("err", "Unavailable");
        DOM.connectionMeta.textContent = "Unable to reach AWS Lambda. Check the endpoint.";
        DOM.dateValue.textContent = "--";
        updateMap();
      }
    }

    init();
  </script>
</body>
</html>
