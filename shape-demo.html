<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shape Classifier Demo</title>
<link rel="stylesheet" href="css/styles.css">
<link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"></noscript>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap" rel="stylesheet"></noscript>
  <style>
  html, body {
    margin: 0;
    padding: 0;
    height: auto;
    overflow: hidden;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    color: var(--text-light);
    text-align: center;
    min-height: 0;
  }
  #demo-box {
    padding: 1rem;
    margin: 0;
  }
  #demo-box h2 { margin: 0 0 .5rem; }
  #demo-box p { margin: 0 0 1rem; }
  #pad-wrapper {
    position: relative;
    display: inline-block;
  }
  canvas {
    border: 2px solid #444;
    touch-action: none;
    background: #000;
    color: #fff;
    width: min(60vmin, 256px);
    height: min(60vmin, 256px);
  }
  #clear {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 32px;
    height: 32px;
    border: none;
    background: var(--primary);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #clear i { color: var(--bg); }
  #clear:hover {
    filter: brightness(1.1);
  }
  #clear:hover i { color: var(--bg); }
  #buttons {
    margin-top: 1rem;
    display: flex;
    gap: .5rem;
    justify-content: center;
  }
  button { margin: 0; font-size: 1rem; }
  #classify {
    width: min(60vmin, 256px);
    margin: 0 auto;
  }
  #result {
    line-height: 1.2;
    margin: 1rem auto 0;
    font-size: 1rem;
    height: 3.6em;
    width: min(60vmin, 256px);
    white-space: pre-line;
    border: 1px solid var(--surface-accent);
    padding: 0.25rem;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #status {
    margin-top: 1rem;
    min-height: 1.2em;
    font-size: 1rem;
    text-align: left;
    width: min(60vmin, 256px);
    margin-left: auto;
    margin-right: auto;
  }
  #status ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  #status li {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
  }
  #status li i {
    margin-right: 0.5rem;
  }
  #status li.not-started {
    color: var(--text-muted);
  }
  #status li.in-progress {
    color: var(--secondary);
  }
  #status li.done {
    color: var(--primary);
  }
  #status li.flashing {
    animation: pulse 1s infinite;
  }
  @keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

  @media (max-width: 600px) {
    #buttons { flex-direction: column; }
    #buttons button { width: min(60vmin, 256px); margin: 0 auto; }
    #buttons button + button { margin-top: .5rem; }
  }
</style>
</head>
<body>

<script>
  function notifyResize() {
    try { parent.postMessage({ type: 'shape-demo-resize' }, '*'); } catch(e) {}
  }
  window.addEventListener('load', notifyResize);
  try { document.fonts.ready.then(notifyResize); } catch(e) {}
</script>

<div id="demo-box">
  <h2>Draw a Shape!</h2>
  <p class="modal-subtitle">(Circle, Triangle, Square, Hexagon, Octagon)</p>
  <div id="pad-wrapper">
    <canvas id="pad" width="256" height="256"></canvas>
    <button id="clear" aria-label="Clear"><i class="fas fa-trash"></i></button>
  </div>

  <div id="buttons">
    <button id="classify" class="btn-primary">Classify</button>
  </div>

  <div id="status" class="modal-subtitle"></div>
  <div id="result" class="modal-text"></div>
</div>

<script type="module">
const FN_URL = "https://zcosyfxhs3sntpwzo3qayki2he0kdxkw.lambda-url.us-east-2.on.aws/";   // Lambda endpoint with CORS

// ---------- simple drawing pad ----------
const canvas      = document.getElementById("pad");
const ctx         = canvas.getContext("2d", { willReadFrequently: true });
const clearBtn    = document.getElementById("clear");
const classifyBtn = document.getElementById("classify");
const resultEl    = document.getElementById("result");
const statusEl    = document.getElementById("status");

const tasks = [
  { id: 'submit', label: 'Submit drawing' },
  { id: 'process', label: 'Processing with AWS Lambda' },
  { id: 'complete', label: 'Complete' }
];

function renderTaskList() {
  statusEl.innerHTML = '';
  const ul = document.createElement('ul');
  tasks.forEach(t => {
    const li = document.createElement('li');
    li.id = `task-${t.id}`;
    li.className = 'not-started';
    const icon = document.createElement('i');
    icon.className = 'fa-solid fa-xmark';
    li.appendChild(icon);
    li.append(` ${t.label}`);
    ul.appendChild(li);
  });
  statusEl.appendChild(ul);
  notifyResize();
}

function setTaskState(id, state) {
  const li = document.getElementById(`task-${id}`);
  if (!li) return;
  const icon = li.querySelector('i');
  li.className = state;
  li.classList.toggle('flashing', id === 'process' && state === 'in-progress');
  if (state === 'in-progress') {
    icon.className = 'fa-solid fa-spinner fa-spin';
  } else if (state === 'done') {
    icon.className = 'fa-solid fa-check';
  } else {
    icon.className = 'fa-solid fa-xmark';
  }
  notifyResize();
}

function fitResultText() {
  resultEl.style.fontSize = "";
  const maxH = resultEl.clientHeight;
  let size = parseFloat(getComputedStyle(resultEl).fontSize);
  while (resultEl.scrollHeight > maxH && size > 8) {
    size -= 1;
    resultEl.style.fontSize = size + "px";
  }
}

const CANVAS_BG = "#000";
let   hasDrawn   = false;

ctx.lineWidth = 6;
ctx.lineCap   = "round";
resetCanvas();

function resetCanvas() {
  ctx.fillStyle = CANVAS_BG.trim();
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "white";
  hasDrawn = false;
}
clearBtn.onclick = () => { resetCanvas(); draw = false; };

let draw = false;
const pos = e => {
  const r = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
  const scaleX = canvas.width  / r.width;
  const scaleY = canvas.height / r.height;
  return [ x * scaleX, y * scaleY ];
};

canvas.addEventListener("pointerdown", e => { e.preventDefault(); draw = true; ctx.beginPath(); ctx.moveTo(...pos(e)); });
canvas.addEventListener("pointermove", e => { if (draw) { e.preventDefault(); ctx.lineTo(...pos(e)); ctx.stroke(); hasDrawn = true; }});
["pointerup","pointerleave","pointercancel"].forEach(evt => canvas.addEventListener(evt, () => draw = false));

// ---------- classify button ----------
classifyBtn.onclick = async () => {
  if (!hasDrawn) {
    resultEl.textContent = "Please draw a shape first.";
    fitResultText();
    notifyResize();
    return;
  }
  resultEl.textContent = '';
  renderTaskList();
  setTaskState('submit', 'in-progress');
  clearBtn.disabled = true;
  classifyBtn.disabled = true;
  const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
  const b64  = await blob.arrayBuffer().then(buf => btoa(String.fromCharCode(...new Uint8Array(buf))));

  try {
    setTaskState('submit', 'done');
    setTaskState('process', 'in-progress');
    const res   = await fetch(FN_URL, {
      method : "POST",
      headers: { "Content-Type": "application/json" },
      body   : JSON.stringify({ b64 })
    });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const {class: cls, confidence} = await res.json();
    const shape = cls.charAt(0).toUpperCase() + cls.slice(1);
    setTaskState('process', 'done');
    setTaskState('complete', 'done');
    resultEl.textContent =
        `Prediction: ${shape}\nConfidence: ${(confidence*100).toFixed(1)}%`;
    fitResultText();
  } catch (err) {
    setTaskState('process', 'not-started');
    setTaskState('complete', 'not-started');
    resultEl.textContent = "Error: " + err;
    fitResultText();
  } finally {
    clearBtn.disabled = false;
    classifyBtn.disabled = false;
    notifyResize();
  }
};
</script>
</body>
</html>
