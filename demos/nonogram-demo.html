<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <base href="/">
  <title>Nonogram Solver Demo</title>

  <meta name="theme-color" content="#0D1117">
  <link rel="stylesheet" href="dist/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600&display=swap">

  <style>
    :root {
      --radius: 14px;
      --shadow-1: 0 2px 10px rgba(0,0,0,.06), 0 1px 4px rgba(0,0,0,.06);
      --shadow-2: 0 8px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.08);
      --surface-2: var(--surface-light);
      --text: var(--text-light);
      --page-pad: clamp(12px, 3vw, 24px);
      --cell-size: clamp(38px, 6vw, 54px);
      --clue-size: clamp(70px, 10vw, 96px);
      --log-row-height: 36px;
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }
    html[data-embedded="true"],
    html[data-embedded="true"] body{
      height: auto !important;
      min-height: 0 !important;
    }
    html[data-embedded="true"] {
      --page-pad: clamp(8px, 2vw, 16px);
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 500px at 50% -10%, color-mix(in srgb, var(--primary) 15%, transparent), transparent 60%) var(--bg);
      display: grid;
      place-items: start center;
      padding: var(--page-pad);
      overflow-x: hidden;
    }

    #demo-box {
      width: min(100%, 980px);
      background: var(--surface);
      border: 1px solid var(--surface-accent);
      border-radius: var(--radius);
      box-shadow: var(--shadow-2);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto auto auto;
    }

    html[data-embedded="true"] #demo-box{
      min-height: 0 !important;
    }

    header.card-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 18px;
      background: linear-gradient(0deg, var(--surface), var(--surface-2));
      border-bottom: 1px solid var(--surface-accent);
    }

    .header-copy {
      min-width: 0;
      display: grid;
      gap: 6px;
    }

    .title {
      font-family: Poppins, Inter, system-ui, sans-serif;
      font-weight: 600;
      margin: 0;
      font-size: clamp(1.1rem, 2.2vw, 1.35rem);
    }

    .subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: .9rem;
      max-width: 60ch;
    }

    .health-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 8px 16px 0;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 12px 16px 0;
    }

    .controls label {
      font-size: .85rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .controls input[type="number"] {
      width: 110px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--surface-accent);
      background: var(--surface);
      color: var(--text);
    }

    .health-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--surface-accent);
      background: var(--surface-2);
      font-size: .7rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .health-pill::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .health-pill[data-state="ok"] {
      color: var(--success, #38b37e);
      border-color: color-mix(in srgb, var(--success, #38b37e) 55%, var(--surface-accent) 45%);
    }

    .health-pill[data-state="err"] {
      color: var(--danger, #e05757);
      border-color: color-mix(in srgb, var(--danger, #e05757) 55%, var(--surface-accent) 45%);
    }

    .health-pill[data-state="warming"] {
      color: var(--warning, #f3b550);
      border-color: color-mix(in srgb, var(--warning, #f3b550) 55%, var(--surface-accent) 45%);
    }

    .content {
      display: grid;
      grid-template-columns: auto minmax(260px, 320px);
      gap: 18px;
      justify-content: center;
      align-items: start;
      padding: 16px;
    }

    .board-column {
      display: grid;
      gap: 12px;
      align-items: start;
      justify-items: center;
    }

    .board-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .board-shell {
      position: relative;
      display: grid;
      grid-template-columns: var(--clue-size) repeat(5, var(--cell-size));
      grid-template-rows: var(--clue-size) repeat(5, var(--cell-size));
      gap: 6px;
      align-items: stretch;
      justify-content: center;
      justify-items: stretch;
      background: color-mix(in srgb, var(--surface) 70%, #ffffff 30%);
      border-radius: 16px;
      padding: 12px;
      border: 1px solid var(--surface-accent);
      box-shadow: var(--shadow-1);
      overflow: hidden;
    }

    .board-refresh {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 4;
      width: 34px;
      height: 34px;
      padding: 0;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: color-mix(in srgb, var(--surface) 88%, #000 12%);
      border-color: color-mix(in srgb, var(--surface-accent) 70%, transparent);
    }

    .board-refresh svg {
      width: 16px;
      height: 16px;
    }

    .board-refresh:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .accuracy-toast {
      position: absolute;
      left: 50%;
      bottom: 14px;
      transform: translate(-50%, 6px);
      display: grid;
      gap: 2px;
      min-width: 150px;
      max-width: calc(100% - 16px);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--surface-accent);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      box-shadow: var(--shadow-1);
      text-align: center;
      font-size: .85rem;
      font-weight: 600;
      color: var(--text);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 3;
    }

    .accuracy-toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .solution-trigger {
      position: relative;
      border: 1px dashed var(--surface-accent);
      background: color-mix(in srgb, var(--surface) 88%, #000 12%);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: .75rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      cursor: pointer;
    }

    .solution-trigger:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .solution-trigger::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translate(-50%, 6px);
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--surface-accent);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      color: var(--text-muted);
      font-size: .7rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 4;
    }

    .solution-trigger:hover::after,
    .solution-trigger:focus-visible::after {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .clues-top {
      grid-column: 2 / span 5;
      grid-row: 1;
      display: grid;
      grid-template-columns: repeat(5, var(--cell-size));
      gap: 6px;
    }

    .clues-left {
      grid-column: 1;
      grid-row: 2 / span 5;
      display: grid;
      grid-template-rows: repeat(5, var(--cell-size));
      gap: 6px;
    }

    .clue {
      background: color-mix(in srgb, var(--surface) 70%, #000 30%);
      border: 1px solid var(--surface-accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: 600;
      color: color-mix(in srgb, var(--text-light) 88%, #ffffff 12%);
      font-size: .85rem;
      white-space: pre-line;
      padding: 4px;
    }

    .grid {
      grid-column: 2 / span 5;
      grid-row: 2 / span 5;
      display: grid;
      grid-template-columns: repeat(5, var(--cell-size));
      grid-template-rows: repeat(5, var(--cell-size));
      gap: 6px;
    }

    .cell {
      border-radius: 8px;
      border: 1px solid color-mix(in srgb, var(--surface) 50%, #ffffff 50%);
      background: color-mix(in srgb, var(--surface) 40%, #ffffff 60%);
      display: grid;
      place-items: center;
      font-size: .8rem;
      color: var(--text-muted);
      transition: transform .2s ease, background .2s ease, border-color .2s ease;
    }

    .cell--filled {
      background: #0b0f14;
      border-color: color-mix(in srgb, var(--primary) 55%, #000 45%);
      box-shadow: inset 0 0 0 1px color-mix(in srgb, #ffffff 12%, transparent);
      transform: scale(1.02);
    }

    .cell--empty {
      background: #f6f8fb;
      border-color: #c9d3e0;
      color: #0b0f14;
    }

    .cell--miss {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--danger) 60%, transparent);
    }

    .cell--duplicate {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--warning) 70%, transparent);
    }

    .panel {
      background: color-mix(in srgb, var(--surface) 90%, #000 10%);
      border: 1px solid var(--surface-accent);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: var(--shadow-1);
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .9rem;
      color: var(--text-muted);
    }

    .stat strong {
      color: var(--text);
      font-weight: 600;
    }

    .log {
      overflow: auto;
      display: grid;
      gap: 8px;
      grid-auto-rows: var(--log-row-height);
      height: calc(var(--log-row-height) * 5 + 8px * 4);
      max-height: calc(var(--log-row-height) * 5 + 8px * 4);
      align-content: start;
      scrollbar-gutter: stable;
    }

    .log-entry {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--surface-accent);
      background: color-mix(in srgb, var(--surface) 86%, #000 14%);
      font-size: .8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      min-height: var(--log-row-height);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .log-entry strong {
      color: var(--text);
    }

    .status {
      padding: 0 16px 8px;
      font-size: .85rem;
      color: var(--text-muted);
    }


    @media (max-width: 860px) {
      .content {
        grid-template-columns: 1fr;
      }
      .panel {
        order: 2;
      }
    }

    @media (max-width: 520px) {
      :root {
        --cell-size: 34px;
        --clue-size: 62px;
      }
      .controls input[type="number"] {
        width: 90px;
      }
    }

    @media (max-width: 420px) {
      :root {
        --cell-size: 28px;
        --clue-size: 50px;
        --page-pad: 10px;
      }
      .content {
        padding: 12px;
      }
      .board-shell {
        padding: 8px;
        gap: 4px;
      }
      .clues-top,
      .clues-left,
      .grid {
        gap: 4px;
      }
      .clue {
        font-size: .75rem;
      }
    }
  </style>
  <script>
    if (window.self !== window.top) {
      document.documentElement.setAttribute('data-embedded', 'true');
    }
  </script>
</head>
<body>
  <script>
    (function () {
      var CHANNEL = 'nonogram-demo-resize';
      function calcHeight() {
        var doc = document.documentElement;
        var body = document.body || doc;
        return Math.ceil(Math.max(
          body.scrollHeight,
          body.offsetHeight,
          doc.clientHeight,
          doc.scrollHeight,
          doc.offsetHeight
        ));
      }
      function postHeight() {
        try { parent.postMessage({ type: CHANNEL, height: calcHeight() }, '*'); } catch (e) { }
      }
      window.addEventListener('load', postHeight);
      try { document.fonts?.ready?.then(postHeight); } catch (e) { }
      if ('ResizeObserver' in window) {
        var ro = new ResizeObserver(function () { postHeight(); });
        ro.observe(document.documentElement);
      } else {
        var prev = 0;
        setInterval(function () {
          var h = calcHeight();
          if (Math.abs(h - prev) > 4) {
            prev = h;
            postHeight();
          }
        }, 750);
      }
    })();
  </script>

  <div id="demo-box" role="application" aria-label="Nonogram solver demo">
    <header class="card-header">
      <div class="header-copy">
        <h1 class="title">Nonogram Solver</h1>
        <p class="subtitle">Use the row and column clues (numbers show consecutive filled blocks) to fill the grid; the agent reveals a 5x5 puzzle one pick at a time.</p>
      </div>
    </header>

    <div class="health-row" role="status" aria-live="polite">
      <span id="health-pill" class="health-pill" data-state="warming">Warming up</span>
    </div>

    <div class="status" id="status">Ready. Generate a puzzle to begin.</div>

    <div class="content">
      <div class="board-column">
        <div class="board-shell" aria-label="Nonogram board">
          <button id="new-btn" class="btn-secondary board-refresh" type="button" aria-label="Refresh puzzle" title="Refresh puzzle">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M20 12a8 8 0 1 1-2.35-5.65" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M20 5v5h-5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="clues-top" id="clues-top"></div>
          <div class="clues-left" id="clues-left"></div>
          <div class="grid" id="grid"></div>
          <div id="accuracy-toast" class="accuracy-toast" role="status" aria-live="polite" aria-atomic="true">
            <span class="toast-label">AI Accuracy</span>
            <span class="toast-score">--</span>
          </div>
        </div>
        <div class="board-actions">
          <button id="solve-btn" class="btn-primary" type="button" disabled>Solve With AI</button>
          <button id="solution-btn" class="solution-trigger" type="button" disabled data-tooltip="Hover to show">Solution</button>
        </div>
      </div>

      <aside class="panel" aria-live="polite">
        <div class="stat"><span>Accuracy</span> <strong id="stat-accuracy">-</strong></div>
        <div class="log" id="log"></div>
      </aside>
    </div>
  </div>

  <script src="js/demos/aws-client.js"></script>
  <script type="module">
    const DEFAULT_FN_URL = "https://gw676aqgd4lpcoxngfvnfki5ce0urcfg.lambda-url.us-east-2.on.aws/";
    const STORAGE_KEY = "demo.endpoint.nonogram";
    const LEGACY_KEYS = ["nonogram_fn_url"];
    const { listCandidates, postWithFallback, rememberEndpoint, getJson, normalizeBase } = window.DemoAws;
    const endpointConfig = {
      defaultUrl: DEFAULT_FN_URL,
      storageKey: STORAGE_KEY,
      legacyKeys: LEGACY_KEYS
    };
    const candidates = () => listCandidates(endpointConfig);
    const postToEndpoint = (base, payload) => postWithFallback(base, ['', 'solve', 'predict'], payload);

    const gridEl = document.getElementById('grid');
    const cluesTop = document.getElementById('clues-top');
    const cluesLeft = document.getElementById('clues-left');
    const statusEl = document.getElementById('status');
    const healthPill = document.getElementById('health-pill');
    const logEl = document.getElementById('log');
    const accuracyToast = document.getElementById('accuracy-toast');
    const toastScore = accuracyToast?.querySelector('.toast-score');
    const newBtn = document.getElementById('new-btn');
    const solutionBtn = document.getElementById('solution-btn');
    const solveBtn = document.getElementById('solve-btn');

    const statAccuracy = document.getElementById('stat-accuracy');

    let toastTimer = null;

    let current = null;
    let solving = false;
    let intervalId = null;
    let solutionVisible = false;
    let solutionSnapshot = null;
    let serverReady = false;
    let initialLoadTriggered = false;

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function setHealth(state, text) {
      if (!healthPill) return;
      healthPill.dataset.state = state;
      healthPill.textContent = text;
    }

    function setControlsEnabled(enabled) {
      newBtn.disabled = !enabled;
      if (!enabled) {
        solveBtn.disabled = true;
        solutionBtn.disabled = true;
      }
    }

    function resetStats() {
      statAccuracy.textContent = '-';
      if (accuracyToast) {
        accuracyToast.classList.remove('show');
      }
    }

    function clearLog() {
      logEl.innerHTML = '';
    }

    function appendLog(step, index) {
      const item = document.createElement('div');
      const result = step.result || (step.duplicate ? 'Duplicate' : (step.correct ? 'Correct' : 'Incorrect'));
      const action = step.predicted === 1 ? 'Filled' : 'Empty';
      const messageText = `Step ${index + 1}: r${step.row + 1}c${step.col + 1} -> ${action} (${result})`;
      item.className = 'log-entry';
      item.innerHTML = `Step <strong>${index + 1}</strong>: r${step.row + 1}c${step.col + 1} -> ${action} (${result})`;
      item.title = messageText;
      logEl.prepend(item);
      logEl.scrollTop = 0;
    }

    function showAccuracyToast(accuracyText) {
      if (!accuracyToast || !toastScore) return;
      toastScore.textContent = accuracyText === '-' ? 'Accuracy: --' : `Accuracy: ${accuracyText}`;
      accuracyToast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        accuracyToast.classList.remove('show');
      }, 2400);
    }

    function renderBoard(gridSize) {
      gridEl.innerHTML = '';
      cluesTop.innerHTML = '';
      cluesLeft.innerHTML = '';
      for (let i = 0; i < gridSize; i++) {
        const top = document.createElement('div');
        top.className = 'clue';
        cluesTop.appendChild(top);
        const left = document.createElement('div');
        left.className = 'clue';
        cluesLeft.appendChild(left);
      }
      for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = String(r);
          cell.dataset.col = String(c);
          gridEl.appendChild(cell);
        }
      }
    }

    function renderClues(rows, cols) {
      const rowNodes = cluesLeft.children;
      const colNodes = cluesTop.children;
      rows.forEach((clue, idx) => {
        if (rowNodes[idx]) rowNodes[idx].textContent = clue.join(' ');
      });
      cols.forEach((clue, idx) => {
        if (colNodes[idx]) colNodes[idx].textContent = clue.join('\n');
      });
    }

    function clearBoard() {
      gridEl.querySelectorAll('.cell').forEach(cell => {
        cell.classList.remove('cell--filled', 'cell--empty', 'cell--miss', 'cell--duplicate');
      });
    }

    function captureBoardState() {
      return Array.from(gridEl.querySelectorAll('.cell')).map(cell => cell.className);
    }

    function restoreBoardState(snapshot) {
      if (!Array.isArray(snapshot)) return;
      const cells = gridEl.querySelectorAll('.cell');
      snapshot.forEach((className, idx) => {
        if (cells[idx]) cells[idx].className = className;
      });
    }

    function setCellState(row, col, value) {
      const selector = `.cell[data-row="${row}"][data-col="${col}"]`;
      const cell = gridEl.querySelector(selector);
      if (!cell) return null;
      cell.classList.remove('cell--filled', 'cell--empty', 'cell--miss', 'cell--duplicate');
      cell.classList.add(Number(value) === 1 ? 'cell--filled' : 'cell--empty');
      return cell;
    }

    function applyStep(step) {
      const cell = setCellState(step.row, step.col, step.actual);
      if (!cell) return;
      if (step.result === 'Duplicate' || step.duplicate) {
        cell.classList.add('cell--duplicate');
      } else if (!step.correct) {
        cell.classList.add('cell--miss');
      }
    }

    function getSolutionGrid() {
      if (Array.isArray(current?.solution)) return current.solution;
      const steps = Array.isArray(current?.steps) ? current.steps : [];
      const size = Number.isFinite(current?.grid) ? current.grid : 5;
      if (!steps.length) return null;
      const grid = Array.from({ length: size }, () => Array(size).fill(0));
      steps.forEach(step => {
        if (!Number.isFinite(step.row) || !Number.isFinite(step.col)) return;
        if (typeof step.actual !== 'number') return;
        if (!grid[step.row] || typeof grid[step.row][step.col] === 'undefined') return;
        grid[step.row][step.col] = step.actual;
      });
      return grid;
    }

    function formatAccuracy() {
      if (!current) return '-';
      const steps = Array.isArray(current.steps) ? current.steps : [];
      const total = Number.isFinite(current.step_count) ? current.step_count : steps.length;
      if (!Number.isFinite(total) || total <= 0) return '-';
      const correct = Number.isFinite(current.correct_count)
        ? current.correct_count
        : steps.reduce((acc, step) => acc + (step.correct ? 1 : 0), 0);
      const rate = Number.isFinite(current.correct_rate) ? current.correct_rate : (correct / total);
      if (!Number.isFinite(rate)) return '-';
      return `${Math.round(rate * 100)}% (${correct}/${total})`;
    }

    function stopAnimation() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    function resetSolutionToggle() {
      solutionVisible = false;
      solutionSnapshot = null;
    }

    async function warmUpServer() {
      setHealth('warming', 'Warming AWS');
      setStatus('Warming server...');
      setControlsEnabled(false);
      const endpoints = candidates();
      if (!endpoints.length) {
        setHealth('err', 'No endpoint');
        setStatus('No endpoint configured.');
        serverReady = false;
        return;
      }
      let lastErr = null;
      for (const base of endpoints) {
        try {
          await postToEndpoint(base, {});
          rememberEndpoint(base, STORAGE_KEY);
          serverReady = true;
          setHealth('ok', 'Ready');
          setControlsEnabled(true);
          if (!initialLoadTriggered) {
            initialLoadTriggered = true;
            await loadPuzzle();
          } else {
            setStatus('Ready. Generate a puzzle to begin.');
          }
          return;
        } catch (err) {
          lastErr = err;
        }
        try {
          await getJson(normalizeBase(base));
          rememberEndpoint(base, STORAGE_KEY);
          serverReady = true;
          setHealth('ok', 'Ready');
          setControlsEnabled(true);
          if (!initialLoadTriggered) {
            initialLoadTriggered = true;
            await loadPuzzle();
          } else {
            setStatus('Ready. Generate a puzzle to begin.');
          }
          return;
        } catch (err) {
          lastErr = err;
        }
      }
      serverReady = false;
      setHealth('err', 'Unavailable');
      setStatus('Unable to reach AWS Lambda.');
      if (lastErr) console.error(lastErr);
    }

    async function loadPuzzle() {
      if (!serverReady) {
        setStatus('Server warming up...');
        return;
      }
      stopAnimation();
      solving = false;
      solveBtn.disabled = true;
      solutionBtn.disabled = true;
      setStatus('Generating puzzle...');
      resetStats();
      resetSolutionToggle();
      clearLog();
      clearBoard();

      const payload = {};

      try {
        const endpoints = candidates();
        let data = null;
        for (const base of endpoints) {
          try {
            data = await postToEndpoint(base, payload);
            rememberEndpoint(base, STORAGE_KEY);
            break;
          } catch (err) {
            data = null;
          }
        }
        if (!data) throw new Error('No endpoint available');

        current = data;
        renderBoard(data.grid);
        renderClues(data.row_clues, data.col_clues);
        clearBoard();
        solveBtn.disabled = false;
        solutionBtn.disabled = false;
        setStatus('Puzzle ready. Press Solve With AI to watch the agent.');
      } catch (err) {
        setStatus('Failed to load puzzle.');
        solveBtn.disabled = true;
        solutionBtn.disabled = true;
      }
    }

    function runSolve() {
      if (!current || solving) return;
      const steps = current.steps || [];
      if (!steps.length) return;
      solving = true;
      solveBtn.disabled = true;
      setSolutionVisible(false);
      solutionBtn.disabled = true;
      setStatus('Solving...');
      resetStats();
      resetSolutionToggle();
      clearLog();
      clearBoard();

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (prefersReduced) {
        steps.forEach((step, idx) => {
          applyStep(step);
          appendLog(step, idx);
        });
        finishSolve();
        return;
      }

      let idx = 0;
      intervalId = setInterval(() => {
        if (idx >= steps.length) {
          finishSolve();
          return;
        }
        applyStep(steps[idx]);
        appendLog(steps[idx], idx);
        idx += 1;
      }, 180);
    }

    function setSolutionVisible(nextVisible) {
      if (!current) return false;
      if (nextVisible === solutionVisible) return true;
      if (nextVisible) {
        stopAnimation();
        solving = false;
        solveBtn.disabled = false;
        const solution = getSolutionGrid();
        if (!solution) {
          setStatus('Solution data unavailable.');
          return false;
        }
        solutionSnapshot = captureBoardState();
        clearBoard();
        solution.forEach((row, r) => {
          if (!Array.isArray(row)) return;
          row.forEach((value, c) => {
            setCellState(r, c, value);
          });
        });
        solutionVisible = true;
        return true;
      }
      restoreBoardState(solutionSnapshot);
      solutionVisible = false;
      solutionSnapshot = null;
      return true;
    }

    function previewSolution(show) {
      if (solving || solutionBtn.disabled) return;
      setSolutionVisible(show);
    }

    function finishSolve() {
      stopAnimation();
      solving = false;
      solveBtn.disabled = false;
      const accuracyText = formatAccuracy();
      statAccuracy.textContent = accuracyText;
      showAccuracyToast(accuracyText);
      setStatus('Puzzle Solved!');
    }

    newBtn.addEventListener('click', loadPuzzle);
    solveBtn.addEventListener('click', runSolve);
    solutionBtn.addEventListener('mouseenter', () => previewSolution(true));
    solutionBtn.addEventListener('mouseleave', () => previewSolution(false));

    renderBoard(5);
    resetStats();
    setControlsEnabled(false);
    warmUpServer();
  </script>
</body>
</html>
