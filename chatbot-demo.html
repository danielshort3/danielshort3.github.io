<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chatbot Demo</title>
<link rel="stylesheet" href="css/styles.css">
<link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"></noscript>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap" rel="stylesheet"></noscript>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: auto;
    overflow: hidden;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    color: var(--text-light);
    text-align: center;
    min-height: 0;
  }
  #demo-box {
    padding: 1rem;
    margin: 0;
    text-align: left;
    width: min(80vmin, 400px);
  }
  #prompt {
    width: 100%;
    height: 6em;
    font-size: 0.9rem;
    background: var(--surface-light);
    color: var(--text-light);
    border: 1px solid var(--surface-accent);
    border-radius: 8px;
    padding: 0.5rem;
    resize: vertical;
  }
  #prompt::placeholder {
    color: var(--text-muted);
  }
  #prompt:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }
  #buttons {
    margin-top: 1rem;
    display: flex;
    justify-content: flex-end;
  }
  #status {
    margin-top: 1rem;
    min-height: 1.2em;
    font-size: 0.9rem;
    text-align: left;
  }
  #status ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  #status li {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
  }
  #status li i {
    margin-right: 0.5rem;
  }
  #status li.not-started {
    color: var(--text-muted);
  }
  #status li.in-progress {
    color: var(--secondary);
  }
  #status li.done {
    color: var(--primary);
  }
  #answer {
    line-height: 1.4;
    margin: 1rem 0 0;
    font-size: 0.9rem;
    width: 100%;
    border: 1px solid var(--surface-accent);
    padding: 0.5rem;
    box-sizing: border-box;
    min-height: 6em;
    max-height: 40vh;
    text-align: left;
    overflow-y: auto;
    overflow-wrap: anywhere;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: var(--surface);
    border-radius: 8px;
  }
  #answer.loading { animation: pulse 1s infinite; opacity: 0.6; }
  .message {
    padding: 0.5rem;
    border: 1px solid var(--surface-accent);
    border-radius: 8px;
    background: var(--surface-light);
    white-space: pre-wrap;
    word-break: break-word;
  }
  .message .label {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .message.user .label {
    color: var(--primary);
  }
  .message.bot .label {
    color: var(--secondary);
  }
  #answer .sources {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
  }
  #answer .sources ul {
    padding-left: 1.2rem;
    margin: 0;
  }
  #answer .sources a {
    color: var(--primary);
    word-break: break-all;
  }
  @keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }
</style>
</head>
<body>
<script>
  function notifyResize() {
    try { parent.postMessage({ type: 'chatbot-demo-resize' }, '*'); } catch(e) {}
  }
  window.addEventListener('load', notifyResize);
  try { document.fonts.ready.then(notifyResize); } catch(e) {}
</script>
<div id="demo-box">
  <h2>Ask the Chatbot</h2>
  <form id="chat-form">
    <label for="prompt" class="modal-subtitle">Your message</label>
    <textarea id="prompt" placeholder="Type your message..."></textarea>
    <div id="buttons">
      <button id="ask" type="submit" class="btn-primary">Ask</button>
    </div>
  </form>
  <div id="status" class="modal-subtitle"></div>
  <div id="answer" class="modal-text"></div>
</div>
<script>
const API_URL = 'https://ovodkr9oad.execute-api.us-east-2.amazonaws.com/prod';
async function ask(prompt, onStatus = () => {}) {
  onStatus('SUBMITTING');
  const submit = await fetch(`${API_URL}/submit`, {
    method: 'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({prompt})
  }).then(r=>r.json());
  const outputUri = submit.outputUri;
  async function poll() {
    const url = `${API_URL}/result?outputUri=${encodeURIComponent(outputUri)}`;
    const res = await fetch(url).then(r=>r.json());
    onStatus(res.status);
    if (res.status === 'READY') return res.data;
    if (res.status === 'FAILED') throw new Error(res.error || 'failed');
    await new Promise(r=>setTimeout(r, 2000));
    return poll();
  }
  return poll();
}
const promptEl = document.getElementById('prompt');
const statusEl = document.getElementById('status');
const answerEl = document.getElementById('answer');
const askBtn = document.getElementById('ask');
const form = document.getElementById('chat-form');
const tasks = [
  { id: 'submit', label: 'Submit question' },
  { id: 'process', label: 'Processing with SageMaker' },
  { id: 'complete', label: 'Complete' }
];

function appendMessage(role, text) {
  const msg = document.createElement('div');
  msg.className = `message ${role}`;
  const label = document.createElement('div');
  label.className = 'label';
  label.textContent = role === 'user' ? 'You' : 'Assistant';
  const content = document.createElement('div');
  content.className = 'content';
  content.textContent = text;
  msg.append(label, content);
  answerEl.appendChild(msg);
  answerEl.scrollTop = answerEl.scrollHeight;
  notifyResize();
}

function renderTaskList() {
  statusEl.innerHTML = '';
  const ul = document.createElement('ul');
  tasks.forEach(t => {
    const li = document.createElement('li');
    li.id = `task-${t.id}`;
    li.className = 'not-started';
    const icon = document.createElement('i');
    icon.className = 'fa-solid fa-xmark';
    li.appendChild(icon);
    li.append(` ${t.label}`);
    ul.appendChild(li);
  });
  statusEl.appendChild(ul);
  notifyResize();
}

function setTaskState(id, state) {
  const li = document.getElementById(`task-${id}`);
  if (!li) return;
  const icon = li.querySelector('i');
  li.className = state;
  if (state === 'in-progress') {
    icon.className = 'fa-solid fa-spinner fa-spin';
  } else if (state === 'done') {
    icon.className = 'fa-solid fa-check';
  } else {
    icon.className = 'fa-solid fa-xmark';
  }
  notifyResize();
}

async function handleSubmit(e) {
  if (e) e.preventDefault();
  const prompt = promptEl.value.trim();
  if (!prompt) return;
  appendMessage('user', prompt);
  answerEl.classList.add('loading');
  renderTaskList();
  setTaskState('submit', 'in-progress');
  askBtn.disabled = true;
  try {
    const data = await ask(prompt, status => {
      if (status === 'PENDING') {
        setTaskState('submit', 'done');
        setTaskState('process', 'in-progress');
      } else if (status === 'READY') {
        setTaskState('process', 'done');
        setTaskState('complete', 'done');
      }
    });
    answerEl.classList.remove('loading');
    appendMessage('bot', data.generated_text || JSON.stringify(data));
    const urls = data.source_urls || data.sources || data.urls;
    if (Array.isArray(urls) && urls.length) {
      const srcDiv = document.createElement('div');
      srcDiv.className = 'sources';
      const srcLabel = document.createElement('div');
      srcLabel.textContent = 'Sources:';
      const list = document.createElement('ul');
      urls.forEach(u => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = u;
        li.appendChild(a);
        list.appendChild(li);
      });
      srcDiv.append(srcLabel, list);
      answerEl.lastElementChild.appendChild(srcDiv);
    }
  } catch(err) {
    answerEl.classList.remove('loading');
    setTaskState('process', 'not-started');
    setTaskState('complete', 'not-started');
    appendMessage('bot', err.message);
  } finally {
    askBtn.disabled = false;
    notifyResize();
  }
}

askBtn.onclick = handleSubmit;
form.addEventListener('submit', handleSubmit);
</script>
</body>
</html>
